<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter Atlas Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: #FAF8F3; color: #1E2D3D; min-height: 100vh; }
  .mono { font-family: 'JetBrains Mono', monospace; }
  .display { font-family: 'Roboto Slab', serif; }

  /* Layout */
  .container { max-width: 900px; margin: 0 auto; padding: 0 16px; }
  header { background: #1E3A5F; color: #fff; padding: 20px 24px; border-bottom: 3px solid #D97706; }
  header h1 { font-family: 'Roboto Slab', serif; font-size: 22px; font-weight: 800; }
  header p { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px; }

  /* Login */
  #login-screen { max-width: 380px; margin: 80px auto; padding: 0 16px; }
  #login-screen h2 { font-family: 'Roboto Slab', serif; color: #1E3A5F; font-size: 24px; margin-bottom: 8px; }
  #login-screen p { color: #4A5568; font-size: 14px; margin-bottom: 24px; }

  /* Forms */
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 11px; font-weight: 700; color: #6B7280; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-family: 'JetBrains Mono', monospace; }
  input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #8F8778; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 14px; background: #fff; color: #1E2D3D; }
  input:focus, select:focus, textarea:focus { outline: none; border-color: #D97706; box-shadow: 0 0 0 3px rgba(217,119,6,0.1); }
  textarea { resize: vertical; min-height: 80px; }
  select { cursor: pointer; }

  /* Buttons */
  .btn { padding: 10px 20px; border: none; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.15s; }
  .btn-primary { background: #1E3A5F; color: #fff; }
  .btn-primary:hover { background: #2a4f7a; }
  .btn-saffron { background: #D97706; color: #fff; }
  .btn-saffron:hover { background: #B45309; }
  .btn-outline { background: transparent; border: 1px solid #8F8778; color: #4A5568; }
  .btn-outline:hover { border-color: #D97706; color: #92400E; }
  .btn-danger { background: #B91C1C; color: #fff; }
  .btn-sm { padding: 6px 12px; font-size: 12px; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Cards */
  .card { background: #fff; border: 1px solid #8F8778; border-radius: 10px; box-shadow: 0 1px 3px rgba(30,45,61,0.04); }
  .card-body { padding: 20px; }

  /* Tabs */
  .tabs { display: flex; gap: 0; border-bottom: 1px solid #8F8778; background: #fff; position: sticky; top: 0; z-index: 50; }
  .tab-btn { padding: 12px 20px; font-size: 13px; font-weight: 500; border: none; background: transparent; cursor: pointer; color: #6B7280; border-bottom: 2px solid transparent; font-family: 'DM Sans', sans-serif; transition: all 0.15s; }
  .tab-btn.active { color: #1E3A5F; font-weight: 700; border-bottom-color: #D97706; }
  .tab-content { display: none; padding: 24px 0; }
  .tab-content.active { display: block; }

  /* Sub-tabs */
  .sub-tabs { display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap; }
  .sub-tab { padding: 6px 14px; font-size: 12px; border-radius: 6px; border: 1px solid #8F8778; background: #fff; color: #4A5568; cursor: pointer; font-weight: 600; transition: all 0.15s; }
  .sub-tab.active { border-color: #B45309; background: #FFFBEB; color: #92400E; }

  /* Progress */
  .progress-bar { width: 100%; height: 6px; background: #E8E3D8; border-radius: 3px; overflow: hidden; margin: 12px 0; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, #D97706, #B45309); border-radius: 3px; transition: width 0.3s; }

  /* Status */
  .status { padding: 10px 14px; border-radius: 6px; font-size: 13px; margin: 12px 0; }
  .status-info { background: #DBEAFE; color: #1E40AF; }
  .status-success { background: #ECFDF5; color: #047857; }
  .status-error { background: #FEF2F2; color: #991B1B; }
  .status-warn { background: #FFFBEB; color: #92400E; }

  /* Preview table */
  .preview-table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 12px 0; }
  .preview-table th { text-align: left; padding: 8px 10px; background: #F5F2EB; font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; color: #6B7280; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #8F8778; }
  .preview-table td { padding: 8px 10px; border-bottom: 1px solid #E8E3D8; }
  .preview-table tr:hover { background: #FFFBEB; }

  /* Misc */
  .flex { display: flex; } .gap-8 { gap: 8px; } .gap-12 { gap: 12px; } .gap-16 { gap: 16px; }
  .items-center { align-items: center; } .justify-between { justify-content: space-between; }
  .mt-8 { margin-top: 8px; } .mt-12 { margin-top: 12px; } .mt-16 { margin-top: 16px; } .mt-24 { margin-top: 24px; }
  .mb-8 { margin-bottom: 8px; } .mb-16 { margin-bottom: 16px; } .mb-24 { margin-bottom: 24px; }
  .text-muted { color: #6B7280; font-size: 12px; }
  .text-sm { font-size: 13px; }
  .font-bold { font-weight: 700; }
  .hidden { display: none; }
  .badge { display: inline-block; font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; }
  .badge-saffron { background: #FFFBEB; color: #92400E; }
  .badge-green { background: #ECFDF5; color: #047857; }
  .badge-purple { background: #EDE9FE; color: #6D28D9; }

  @media (max-width: 600px) {
    .card-body { padding: 14px; }
    .tab-btn { padding: 10px 12px; font-size: 11px; }
    .form-row { flex-direction: column; }
  }
</style>
</head>
<body>

<!-- â•â•â• LOGIN SCREEN â•â•â• -->
<div id="login-screen">
  <div style="text-align:center; margin-bottom: 32px;">
    <div class="display" style="font-size:20px; font-weight:800; color:#1E3A5F;">Indian American Voter Atlas</div>
    <div class="mono" style="font-size:10px; color:#D97706; letter-spacing:2px; margin-top:4px;">ADMIN</div>
  </div>
  <div class="card">
    <div class="card-body">
      <div id="auth-mode-login">
        <h2 class="display" style="font-size:20px; margin-bottom:16px;">Sign In</h2>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" placeholder="you@example.com" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div id="login-error" class="status status-error hidden"></div>
        <button class="btn btn-primary" style="width:100%; margin-top:8px;" onclick="handleLogin()">Sign In</button>
        <p class="text-muted mt-16" style="text-align:center;">
          First time? <a href="#" onclick="showSignup(); return false;" style="color:#1E40AF;">Create admin account</a>
        </p>
      </div>
      <div id="auth-mode-signup" class="hidden">
        <h2 class="display" style="font-size:20px; margin-bottom:16px;">Create Account</h2>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="signup-email" placeholder="you@example.com" />
        </div>
        <div class="form-group">
          <label>Password (min 8 characters)</label>
          <input type="password" id="signup-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div id="signup-error" class="status status-error hidden"></div>
        <div id="signup-success" class="status status-success hidden"></div>
        <button class="btn btn-saffron" style="width:100%; margin-top:8px;" onclick="handleSignup()">Create Account</button>
        <p class="text-muted mt-16" style="text-align:center;">
          <a href="#" onclick="showLogin(); return false;" style="color:#1E40AF;">Back to sign in</a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• ADMIN DASHBOARD â•â•â• -->
<div id="admin-dashboard" class="hidden">
  <header>
    <div class="container flex justify-between items-center">
      <div>
        <h1 class="display">Voter Atlas Admin</h1>
        <p>Data management & API tools</p>
      </div>
      <div class="flex gap-8 items-center">
        <span id="user-email" class="mono" style="font-size:11px; color:rgba(255,255,255,0.6);"></span>
        <button class="btn btn-sm btn-outline" style="color:rgba(255,255,255,0.7); border-color:rgba(255,255,255,0.3);" onclick="handleLogout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('edit')">Quick Edit</button>
      <button class="tab-btn" onclick="switchTab('loaders')">Data Loaders</button>
      <button class="tab-btn" onclick="switchTab('discourse')">Discourse Loader</button>
      <button class="tab-btn" onclick="switchTab('tables')">Tables</button>
    </div>

    <!-- â•â•â• QUICK EDIT TAB â•â•â• -->
    <div id="tab-edit" class="tab-content active">
      <div class="sub-tabs">
        <button class="sub-tab active" onclick="switchSubTab('edit-district')">Update District</button>
        <button class="sub-tab" onclick="switchSubTab('edit-incident')">Add Incident</button>
        <button class="sub-tab" onclick="switchSubTab('edit-event')">Add Event</button>
        <button class="sub-tab" onclick="switchSubTab('edit-narrative')">Update Narrative</button>
        <button class="sub-tab" onclick="switchSubTab('edit-senate')">Update Senate</button>
      </div>

      <!-- Update District -->
      <div id="edit-district" class="sub-content active">
        <div class="card"><div class="card-body">
          <h3 class="display mb-8" style="font-size:16px; color:#1E3A5F;">Update District</h3>
          <p class="text-muted mb-16">Change Cook rating, representative, or notes for a district.</p>
          <div class="form-group">
            <label>Select District</label>
            <select id="dist-select" onchange="loadDistrictData()">
              <option value="">Choose...</option>
            </select>
          </div>
          <div id="dist-fields" class="hidden">
            <div class="flex gap-12" style="flex-wrap:wrap;">
              <div class="form-group" style="flex:1; min-width:200px;">
                <label>Representative</label>
                <input type="text" id="dist-rep" />
              </div>
              <div class="form-group" style="flex:1; min-width:200px;">
                <label>Party</label>
                <select id="dist-party"><option value="D">D</option><option value="R">R</option></select>
              </div>
            </div>
            <div class="flex gap-12" style="flex-wrap:wrap;">
              <div class="form-group" style="flex:1; min-width:200px;">
                <label>Cook 2026 Rating</label>
                <select id="dist-cook">
                  <option>Solid D</option><option>Likely D</option><option>Lean D</option>
                  <option>Toss Up</option>
                  <option>Lean R</option><option>Likely R</option><option>Solid R</option>
                  <option>Special Election</option>
                </select>
              </div>
              <div class="form-group" style="flex:1; min-width:200px;">
                <label>Cook PVI</label>
                <input type="text" id="dist-pvi" placeholder="e.g. D+6" />
              </div>
            </div>
            <div class="flex gap-12" style="flex-wrap:wrap;">
              <div class="form-group" style="flex:1; min-width:120px;">
                <label>Density Score</label>
                <input type="number" id="dist-density" min="0" max="100" />
              </div>
              <div class="form-group" style="flex:1; min-width:120px;">
                <label>Persuasion Score</label>
                <input type="number" id="dist-persuasion" min="0" max="100" />
              </div>
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea id="dist-notes"></textarea>
            </div>
            <div id="dist-status"></div>
            <button class="btn btn-saffron mt-8" onclick="saveDistrict()">Save Changes</button>
          </div>
        </div></div>
      </div>

      <!-- Add Incident -->
      <div id="edit-incident" class="sub-content hidden">
        <div class="card"><div class="card-body">
          <h3 class="display mb-8" style="font-size:16px; color:#1E3A5F;">Add Incident</h3>
          <p class="text-muted mb-16">Log a new hate crime or bias incident.</p>
          <div class="flex gap-12" style="flex-wrap:wrap;">
            <div class="form-group" style="flex:1; min-width:200px;">
              <label>Date</label>
              <input type="date" id="inc-date" />
            </div>
            <div class="form-group" style="flex:1; min-width:200px;">
              <label>Location</label>
              <input type="text" id="inc-location" placeholder="City, State" />
            </div>
          </div>
          <div class="form-group">
            <label>Target</label>
            <input type="text" id="inc-target" placeholder="e.g. BAPS Shri Swaminarayan Mandir" />
          </div>
          <div class="flex gap-12" style="flex-wrap:wrap;">
            <div class="form-group" style="flex:1; min-width:150px;">
              <label>Type</label>
              <select id="inc-type"><option>Vandalism</option><option>Assault</option><option>Arson</option><option>Threat</option><option>Mass Shooting</option><option>Other</option></select>
            </div>
            <div class="form-group" style="flex:1; min-width:150px;">
              <label>Bias</label>
              <select id="inc-bias"><option>Anti-Hindu</option><option>Anti-Sikh</option><option>Anti-Hindu / Pro-Khalistani</option><option>Anti-Indian</option><option>White Supremacist</option><option>Other</option></select>
            </div>
            <div class="form-group" style="flex:1; min-width:120px;">
              <label>Severity</label>
              <select id="inc-severity"><option>medium</option><option>high</option><option>critical</option></select>
            </div>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="inc-desc" placeholder="What happened..."></textarea>
          </div>
          <div class="form-group">
            <label>Source</label>
            <input type="text" id="inc-source" placeholder="e.g. FBI, Sikh Coalition, local media" />
          </div>
          <div id="inc-status"></div>
          <button class="btn btn-saffron mt-8" onclick="saveIncident()">Add Incident</button>
        </div></div>
      </div>

      <!-- Add Discourse Event -->
      <div id="edit-event" class="sub-content hidden">
        <div class="card"><div class="card-body">
          <h3 class="display mb-8" style="font-size:16px; color:#1E3A5F;">Add Discourse Event</h3>
          <p class="text-muted mb-16">Log a legislative, policy, or media event for the timeline.</p>
          <div class="flex gap-12" style="flex-wrap:wrap;">
            <div class="form-group" style="flex:1; min-width:150px;">
              <label>Date (YYYY-MM)</label>
              <input type="text" id="evt-date" placeholder="2026-03" />
            </div>
            <div class="form-group" style="flex:1; min-width:150px;">
              <label>Type</label>
              <select id="evt-type"><option>legislation</option><option>policy</option><option>incident</option><option>electoral</option><option>advocacy</option><option>rhetoric</option><option>research</option><option>data</option></select>
            </div>
            <div class="form-group" style="flex:1; min-width:120px;">
              <label>Valence</label>
              <select id="evt-valence"><option>positive</option><option>neutral</option><option>negative</option></select>
            </div>
          </div>
          <div class="form-group">
            <label>Actor</label>
            <input type="text" id="evt-actor" placeholder="e.g. 119th Congress, FBI, White House" />
          </div>
          <div class="form-group">
            <label>Event headline</label>
            <input type="text" id="evt-event" placeholder="Short headline..." />
          </div>
          <div class="form-group">
            <label>Detail</label>
            <textarea id="evt-detail" placeholder="Full description..."></textarea>
          </div>
          <div class="form-group">
            <label>Source</label>
            <input type="text" id="evt-source" placeholder="e.g. Congress.gov, AP, Sikh Coalition" />
          </div>
          <div id="evt-status"></div>
          <button class="btn btn-saffron mt-8" onclick="saveEvent()">Add Event</button>
        </div></div>
      </div>

      <!-- Update Narrative -->
      <div id="edit-narrative" class="sub-content hidden">
        <div class="card"><div class="card-body">
          <h3 class="display mb-8" style="font-size:16px; color:#1E3A5F;">Update Narrative Tracker</h3>
          <p class="text-muted mb-16">Update intensity, direction, or framing of tracked narratives.</p>
          <div class="form-group">
            <label>Select Narrative</label>
            <select id="narr-select" onchange="loadNarrativeData()"><option value="">Choose...</option></select>
          </div>
          <div id="narr-fields" class="hidden">
            <div class="flex gap-12" style="flex-wrap:wrap;">
              <div class="form-group" style="flex:1; min-width:150px;">
                <label>Intensity</label>
                <select id="narr-intensity"><option>high</option><option>medium</option><option>low</option></select>
              </div>
              <div class="form-group" style="flex:1; min-width:150px;">
                <label>Direction</label>
                <select id="narr-direction"><option>growing</option><option>stable</option><option>fading</option></select>
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="narr-desc" style="min-height:100px;"></textarea>
            </div>
            <div class="form-group">
              <label>Sample Framing</label>
              <textarea id="narr-framing"></textarea>
            </div>
            <div class="form-group">
              <label>Date Range</label>
              <input type="text" id="narr-daterange" placeholder="e.g. Nov 2024 â€“ present" />
            </div>
            <div id="narr-status"></div>
            <button class="btn btn-saffron mt-8" onclick="saveNarrative()">Save Changes</button>
          </div>
        </div></div>
      </div>

      <!-- Update Senate -->
      <div id="edit-senate" class="sub-content hidden">
        <div class="card"><div class="card-body">
          <h3 class="display mb-8" style="font-size:16px; color:#1E3A5F;">Update Senate Race</h3>
          <p class="text-muted mb-16">Change rating, incumbent, or notes for a senate race.</p>
          <div class="form-group">
            <label>Select State</label>
            <select id="sen-select" onchange="loadSenateData()"><option value="">Choose...</option></select>
          </div>
          <div id="sen-fields" class="hidden">
            <div class="flex gap-12" style="flex-wrap:wrap;">
              <div class="form-group" style="flex:1; min-width:200px;">
                <label>Incumbent</label>
                <input type="text" id="sen-incumbent" />
              </div>
              <div class="form-group" style="flex:1; min-width:150px;">
                <label>Rating</label>
                <select id="sen-rating">
                  <option>Toss Up</option><option>Lean D</option><option>Lean R</option>
                  <option>Likely D</option><option>Likely R</option>
                  <option>Solid D</option><option>Solid R</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea id="sen-notes"></textarea>
            </div>
            <div id="sen-status"></div>
            <button class="btn btn-saffron mt-8" onclick="saveSenate()">Save Changes</button>
          </div>
        </div></div>
      </div>
    </div>

    <!-- â•â•â• DATA LOADERS TAB â•â•â• -->
    <div id="tab-loaders" class="tab-content">

      <!-- Overpass: Temples -->
      <div class="card mb-24">
        <div class="card-body">
          <div class="flex justify-between items-center mb-8">
            <h3 class="display" style="font-size:16px; color:#1E3A5F;">ğŸ›• Temple & Gurdwara Count</h3>
            <span class="badge badge-saffron">OpenStreetMap</span>
          </div>
          <p class="text-muted mb-16">Pulls all Hindu temples and Sikh gurdwaras from OpenStreetMap, maps each to a congressional district using the Census geocoder, and saves per-district counts. Backs up the Cultural Business Density factor (20% of Density Index).</p>
          <button class="btn btn-saffron" id="btn-overpass" onclick="runOverpass()">Pull Temple Data</button>
          <div id="overpass-status" class="mt-12"></div>
          <div class="progress-bar hidden" id="overpass-progress"><div class="progress-fill" id="overpass-fill" style="width:0%"></div></div>
          <div id="overpass-preview" class="mt-12"></div>
          <button class="btn btn-primary mt-12 hidden" id="btn-overpass-save" onclick="saveOverpassData()">Save to Database</button>
        </div>
      </div>

      <!-- Census: Language -->
      <div class="card mb-24">
        <div class="card-body">
          <div class="flex justify-between items-center mb-8">
            <h3 class="display" style="font-size:16px; color:#1E3A5F;">ğŸ—£ï¸ Census Language Data</h3>
            <span class="badge badge-purple">Census API</span>
          </div>
          <p class="text-muted mb-16">Pulls language-spoken-at-home data from the ACS 5-Year Estimates for your 24 tracked districts. Shows South Asian language speakers and limited English proficiency rates.</p>
          <button class="btn btn-saffron" id="btn-census" onclick="runCensus()">Pull Language Data</button>
          <div id="census-status" class="mt-12"></div>
          <div id="census-preview" class="mt-12"></div>
          <button class="btn btn-primary mt-12 hidden" id="btn-census-save" onclick="saveCensusData()">Save to Database</button>
        </div>
      </div>

      <!-- Census: Population Verify -->
      <div class="card mb-24">
        <div class="card-body">
          <div class="flex justify-between items-center mb-8">
            <h3 class="display" style="font-size:16px; color:#1E3A5F;">ğŸ“Š Verify Population Data</h3>
            <span class="badge badge-purple">Census API</span>
          </div>
          <p class="text-muted mb-16">Pulls Asian Indian alone population (Table B02015) from the ACS 5-Year Estimates and compares it to your current district data. Flags any discrepancies.</p>
          <button class="btn btn-outline" id="btn-verify" onclick="runVerify()">Verify Against Census</button>
          <div id="verify-status" class="mt-12"></div>
          <div id="verify-preview" class="mt-12"></div>
        </div>
      </div>

      <!-- Congress.gov: Bill Tracker -->
      <div class="card mb-24">
        <div class="card-body">
          <div class="flex justify-between items-center mb-8">
            <h3 class="display" style="font-size:16px; color:#1E3A5F;">ğŸ“œ Bill Tracker</h3>
            <span class="badge" style="background:#FEE2E2; color:#991B1B;">Congress.gov</span>
          </div>
          <p class="text-muted mb-16">Search Congress.gov for bills relevant to Indian Americans â€” immigration, H-1B, hate crimes, India relations. Save bills to track their progress on your dashboard.</p>
          <div class="flex gap-8 mb-16" style="flex-wrap:wrap;">
            <input type="text" id="bill-query" placeholder="Search keyword (e.g. H-1B, green card, hate crime)" style="flex:1; min-width:200px;" />
            <button class="btn btn-saffron" onclick="searchBills()">Search</button>
          </div>
          <div class="sub-tabs mb-16">
            <button class="sub-tab active" onclick="switchBillView('search')">Search Results</button>
            <button class="sub-tab" onclick="switchBillView('tracked')">Tracked Bills (<span id="tracked-count">0</span>)</button>
          </div>
          <div id="bill-search-view">
            <div id="bill-status" class="mt-12"></div>
            <div id="bill-preview" class="mt-12"></div>
          </div>
          <div id="bill-tracked-view" class="hidden">
            <div id="tracked-bills-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• DISCOURSE LOADER TAB â•â•â• -->
    <div id="tab-discourse" class="tab-content">

      <!-- Config card -->
      <div class="card mb-24">
        <div class="card-body">
          <div class="flex justify-between items-center mb-8">
            <h3 class="display" style="font-size:16px; color:#1E3A5F;">ğŸ“¡ Media & Policy Signal Loader</h3>
            <span class="badge badge-saffron">GDELT + GovInfo</span>
          </div>
          <p class="text-muted mb-16">Pulls framing and tone data from GDELT's article archive (DOC 2.0) and TV broadcast archive (TV 2.0), plus floor speech text from the Congressional Record via GovInfo. No key needed for GDELT. GovInfo key is free at <a href="https://api.govinfo.gov/docs/" target="_blank" style="color:#D97706;">api.govinfo.gov/docs</a>.</p>

          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
            <div>
              <label class="form-label">Narrative Query Pack</label>
              <select id="disc-queryPack" onchange="discOnPackChange()" style="width:100%; padding:8px 10px; border:1px solid #E5E7EB; border-radius:6px; font-size:13px;">
                <option value="h1b">H-1B Visa / Tech Workforce</option>
                <option value="iamerican">Indian Americans (political)</option>
                <option value="southasian">South Asian Hate / Discrimination</option>
                <option value="indiarelations">US-India Relations</option>
                <option value="greencard">Green Card Backlog</option>
                <option value="custom">Custom Queryâ€¦</option>
              </select>
            </div>
            <div>
              <label class="form-label">Lookback Window</label>
              <select id="disc-timespan" style="width:100%; padding:8px 10px; border:1px solid #E5E7EB; border-radius:6px; font-size:13px;">
                <option value="1months">1 Month</option>
                <option value="3months" selected>3 Months</option>
                <option value="6months">6 Months</option>
                <option value="1year">1 Year</option>
              </select>
            </div>
            <div>
              <label class="form-label">Max Articles (GDELT DOC)</label>
              <select id="disc-maxRecords" style="width:100%; padding:8px 10px; border:1px solid #E5E7EB; border-radius:6px; font-size:13px;">
                <option value="50">50 articles</option>
                <option value="100">100 articles</option>
                <option value="250" selected>250 articles</option>
              </select>
            </div>
          </div>

          <div id="disc-customRow" style="display:none; margin-bottom:16px;">
            <label class="form-label">Custom Search Query</label>
            <input type="text" id="disc-customQuery" placeholder='"Indian Americans" AND H-1B OR "tech workers"' style="width:100%;" />
          </div>

          <div style="background:#FFFBEB; border:1px solid #FDE68A; border-radius:8px; padding:14px 16px; margin-bottom:16px; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <div>
              <label class="form-label">GovInfo API Key <span style="font-weight:400; color:#9CA3AF;">(optional â€” skip for GDELT only)</span></label>
              <input type="password" id="disc-govKey" placeholder="Paste GovInfo key here" style="width:100%;" />
            </div>
            <div>
              <label class="form-label">Note</label>
              <p style="font-size:12px; color:#92400E; margin-top:6px; line-height:1.5;">Your Supabase credentials are already configured above. GDELT requires no key â€” click "GDELT Only" to get data flowing immediately.</p>
            </div>
          </div>

          <div class="flex gap-8">
            <button class="btn btn-saffron" id="disc-runBtn" onclick="discRunAll()">â–¶ Fetch All Sources</button>
            <button class="btn btn-outline" onclick="discRunGdeltOnly()">GDELT Only (no key needed)</button>
            <button class="btn btn-outline" onclick="discClear()">Clear</button>
          </div>
          <div id="disc-status" class="mt-12"></div>
        </div>
      </div>

      <!-- Results: 3 columns -->
      <div id="disc-resultsGrid" style="display:none; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-bottom:24px;">

        <!-- GDELT DOC -->
        <div class="card">
          <div class="card-body">
            <div class="flex justify-between items-center mb-8">
              <h3 class="display" style="font-size:14px; color:#1E3A5F;">ğŸ“° GDELT Articles</h3>
              <span id="disc-gdeltCount" class="badge badge-saffron">â€”</span>
            </div>
            <div style="display:flex; gap:0; border:1px solid #E5E7EB; border-radius:8px; overflow:hidden; margin-bottom:12px;">
              <div style="flex:1; padding:10px; text-align:center; border-right:1px solid #E5E7EB;">
                <div id="disc-avgTone" style="font-family:monospace; font-size:18px; font-weight:700; color:#1E3A5F;">â€”</div>
                <div style="font-size:10px; color:#9CA3AF; text-transform:uppercase; letter-spacing:.05em;">Avg Tone</div>
              </div>
              <div style="flex:1; padding:10px; text-align:center; border-right:1px solid #E5E7EB;">
                <div id="disc-posCount" style="font-family:monospace; font-size:18px; font-weight:700; color:#059669;">â€”</div>
                <div style="font-size:10px; color:#9CA3AF; text-transform:uppercase; letter-spacing:.05em;">Positive</div>
              </div>
              <div style="flex:1; padding:10px; text-align:center;">
                <div id="disc-negCount" style="font-family:monospace; font-size:18px; font-weight:700; color:#DC2626;">â€”</div>
                <div style="font-size:10px; color:#9CA3AF; text-transform:uppercase; letter-spacing:.05em;">Negative</div>
              </div>
            </div>
            <div style="font-size:10px; color:#9CA3AF; text-transform:uppercase; letter-spacing:.05em; margin-bottom:6px;">Top Domains</div>
            <div id="disc-domains" style="font-size:12px; color:#6B7280;">Run fetch to load</div>
            <div id="disc-articles" style="margin-top:12px; max-height:280px; overflow-y:auto;"></div>
          </div>
        </div>

        <!-- GDELT TV -->
        <div class="card">
          <div class="card-body">
            <div class="flex justify-between items-center mb-8">
              <h3 class="display" style="font-size:14px; color:#1E3A5F;">ğŸ“º GDELT TV Broadcasts</h3>
              <span id="disc-tvCount" class="badge" style="background:#DCFCE7; color:#166534;">â€”</span>
            </div>
            <div style="font-size:10px; color:#9CA3AF; text-transform:uppercase; letter-spacing:.05em; margin-bottom:6px;">Station Breakdown</div>
            <div id="disc-stations" style="font-size:12px; color:#6B7280; margin-bottom:12px;">Run fetch to load</div>
            <div id="disc-clips" style="max-height:320px; overflow-y:auto;"></div>
          </div>
        </div>

        <!-- GovInfo -->
        <div class="card">
          <div class="card-body">
            <div class="flex justify-between items-center mb-8">
              <h3 class="display" style="font-size:14px; color:#1E3A5F;">ğŸ›ï¸ Congressional Record</h3>
              <span id="disc-govCount" class="badge" style="background:#FEF3C7; color:#92400E;">â€”</span>
            </div>
            <div style="font-size:10px; color:#9CA3AF; text-transform:uppercase; letter-spacing:.05em; margin-bottom:6px;">Floor Speech Mentions</div>
            <div id="disc-speeches" style="max-height:360px; overflow-y:auto; font-size:12px; color:#6B7280;">GovInfo key required</div>
          </div>
        </div>
      </div>

      <!-- Write to Supabase panel -->
      <div id="disc-writePanel" style="display:none;" class="card mb-24">
        <div class="card-body">
          <h3 class="display mb-4" style="font-size:15px; color:#1E3A5F;">Write to Supabase</h3>
          <p class="text-muted mb-16" style="font-family:monospace; font-size:11px;">Writes to <code>discourse_items</code> (individual records) and <code>narrative_media_signals</code> (weekly rollup). Duplicates are ignored automatically.</p>
          <div id="disc-writeSummary" style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px;"></div>
          <div class="flex gap-8">
            <button class="btn btn-primary" id="disc-writeBtn" onclick="discWriteToSupabase()">âœ“ Confirm &amp; Write to Supabase</button>
            <button class="btn btn-outline" onclick="document.getElementById('disc-writePanel').style.display='none'">Cancel</button>
          </div>
          <div id="disc-writeStatus" class="mt-12"></div>
        </div>
      </div>

      <!-- SQL Setup -->
      <div class="card">
        <div class="card-body">
          <div style="display:flex; align-items:center; gap:12px; cursor:pointer;" onclick="discToggleSQL()">
            <span style="font-size:13px; font-weight:700; color:#1E3A5F;">ğŸ—„ï¸ Supabase SQL Setup</span>
            <span style="font-size:11px; color:#9CA3AF; font-family:monospace;">Run once before first write</span>
            <span style="margin-left:auto; font-size:12px; color:#9CA3AF;" id="disc-sqlIcon">â–¼ Show</span>
          </div>
          <div id="disc-sqlBlock" style="display:none; margin-top:16px;">
            <pre style="background:#F3F4F6; border-radius:7px; padding:14px; font-size:10.5px; line-height:1.8; overflow-x:auto; color:#374151;">CREATE TABLE IF NOT EXISTS discourse_items (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  source TEXT NOT NULL,      -- 'gdelt_doc' | 'gdelt_tv' | 'govinfo'
  type TEXT NOT NULL,        -- 'article' | 'broadcast' | 'floor_speech'
  title TEXT,
  url TEXT,
  published_at TIMESTAMPTZ,
  tone_score NUMERIC(6,3),   -- GDELT tone: -10 to +10
  narrative_key TEXT,        -- 'h1b' | 'iamerican' | 'southasian' etc.
  station TEXT,              -- TV station (broadcast only)
  domain TEXT,               -- publisher domain (articles only)
  snippet TEXT,              -- first ~300 chars
  fetched_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(url)                -- prevents duplicate runs
);

CREATE TABLE IF NOT EXISTS narrative_media_signals (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  narrative_key TEXT NOT NULL,
  week_start DATE NOT NULL,
  article_count INTEGER,
  avg_tone NUMERIC(6,3),
  pct_positive NUMERIC(5,2),
  top_domains JSONB,
  tv_station_counts JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(narrative_key, week_start)
);

ALTER TABLE discourse_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE narrative_media_signals ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public read" ON discourse_items FOR SELECT USING (true);
CREATE POLICY "Service write" ON discourse_items FOR INSERT WITH CHECK (auth.role() = 'service_role');
CREATE POLICY "Public read" ON narrative_media_signals FOR SELECT USING (true);
CREATE POLICY "Service write" ON narrative_media_signals FOR INSERT WITH CHECK (auth.role() = 'service_role');</pre>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• TABLES TAB â•â•â• -->
    <div id="tab-tables" class="tab-content">
      <div class="card">
        <div class="card-body">
          <h3 class="display mb-8" style="font-size:16px; color:#1E3A5F;">Supabase Table Editor</h3>
          <p class="text-muted mb-16">For bulk edits and advanced operations, use the Supabase dashboard directly. It's a full spreadsheet-like editor for all your tables.</p>
          <a href="https://supabase.com/dashboard/project/myasgeeeutbbcahnguei/editor" target="_blank" class="btn btn-primary">Open Supabase Dashboard â†—</a>

          <h4 class="display mt-24 mb-8" style="font-size:14px; color:#1E3A5F;">Table Summary</h4>
          <div id="table-summary">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <footer style="margin-top:40px; padding:20px; text-align:center; border-top:1px solid #E8E3D8;">
    <span class="text-muted">Indian American Voter Atlas Â· Admin Panel</span>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SUPABASE_URL = "https://myasgeeeutbbcahnguei.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15YXNnZWVldXRiYmNhaG5ndWVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjk1NTksImV4cCI6MjA4Njg0NTU1OX0.JxmwK9sc3PA9f5ws96TxHiqGKJaHBSJ4HI_X9sUtJ88";
const CENSUS_KEY = "68e162c0f5a104af1875cc4a4729ec4da0848b57";
const CONGRESS_KEY = "N9HObShPH2bREjqqAn2KtJgxcAaegRAOb49WSm4x";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// State FIPS â†’ abbreviation
const FIPS = {"01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT","10":"DE","11":"DC","12":"FL","13":"GA","15":"HI","16":"ID","17":"IL","18":"IN","19":"IA","20":"KS","21":"KY","22":"LA","23":"ME","24":"MD","25":"MA","26":"MI","27":"MN","28":"MS","29":"MO","30":"MT","31":"NE","32":"NV","33":"NH","34":"NJ","35":"NM","36":"NY","37":"NC","38":"ND","39":"OH","40":"OK","41":"OR","42":"PA","44":"RI","45":"SC","46":"SD","47":"TN","48":"TX","49":"UT","50":"VT","51":"VA","53":"WA","54":"WV","55":"WI","56":"WY"};

// Our 24 tracked districts for lookup
const TRACKED_DISTRICTS = new Set([
  "CA-17","NJ-07","IL-08","CA-06","TX-22","NJ-11","VA-10","WA-07","TX-10","MI-13",
  "NJ-06","GA-07","NY-03","PA-06","NC-09","TX-24","CA-16","NJ-12","VA-11","NY-04",
  "CA-14","NJ-05","MD-08","CA-32"
]);

// Cached data
let allDistricts = [];
let allNarratives = [];
let allSenate = [];
let overpassResults = null;
let censusResults = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showLogin() { $('auth-mode-login').classList.remove('hidden'); $('auth-mode-signup').classList.add('hidden'); }
function showSignup() { $('auth-mode-login').classList.add('hidden'); $('auth-mode-signup').classList.remove('hidden'); }

async function handleLogin() {
  const email = $('login-email').value;
  const pw = $('login-password').value;
  $('login-error').classList.add('hidden');
  const { error } = await sb.auth.signInWithPassword({ email, password: pw });
  if (error) { $('login-error').textContent = error.message; $('login-error').classList.remove('hidden'); }
}

async function handleSignup() {
  const email = $('signup-email').value;
  const pw = $('signup-password').value;
  $('signup-error').classList.add('hidden');
  $('signup-success').classList.add('hidden');
  if (pw.length < 8) { $('signup-error').textContent = "Password must be at least 8 characters."; $('signup-error').classList.remove('hidden'); return; }
  const { error } = await sb.auth.signUp({ email, password: pw });
  if (error) { $('signup-error').textContent = error.message; $('signup-error').classList.remove('hidden'); }
  else { $('signup-success').textContent = "Account created! Check your email to confirm, then sign in."; $('signup-success').classList.remove('hidden'); }
}

async function handleLogout() {
  await sb.auth.signOut();
  $('admin-dashboard').classList.add('hidden');
  $('login-screen').classList.remove('hidden');
}

// Listen for auth state changes
sb.auth.onAuthStateChange((event, session) => {
  if (session) {
    $('login-screen').classList.add('hidden');
    $('admin-dashboard').classList.remove('hidden');
    $('user-email').textContent = session.user.email;
    loadAdminData();
  }
});

// Check existing session on load
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    $('login-screen').classList.add('hidden');
    $('admin-dashboard').classList.remove('hidden');
    $('user-email').textContent = session.user.email;
    loadAdminData();
  }
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD DATA FOR FORMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadAdminData() {
  const { data: dist } = await sb.from('districts').select('*').order('density_score', { ascending: false });
  const { data: narr } = await sb.from('narrative_items').select('*');
  const { data: sen } = await sb.from('senate_races').select('*');
  allDistricts = dist || [];
  allNarratives = narr || [];
  allSenate = sen || [];

  // Populate district dropdown
  const ds = $('dist-select');
  ds.innerHTML = '<option value="">Choose...</option>';
  allDistricts.forEach(d => { const o = document.createElement('option'); o.value = d.id; o.textContent = `${d.id} â€” ${d.rep}`; ds.appendChild(o); });

  // Populate narrative dropdown
  const ns = $('narr-select');
  ns.innerHTML = '<option value="">Choose...</option>';
  allNarratives.forEach((n, i) => { const o = document.createElement('option'); o.value = n.id; o.textContent = n.narrative; ns.appendChild(o); });

  // Populate senate dropdown
  const ss = $('sen-select');
  ss.innerHTML = '<option value="">Choose...</option>';
  allSenate.forEach(s => { const o = document.createElement('option'); o.value = s.state; o.textContent = s.state; ss.appendChild(o); });

  // Load table summary
  loadTableSummary();
  loadTrackedCount();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUICK EDIT HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function loadDistrictData() {
  const id = $('dist-select').value;
  if (!id) { $('dist-fields').classList.add('hidden'); return; }
  const d = allDistricts.find(x => x.id === id);
  if (!d) return;
  $('dist-rep').value = d.rep;
  $('dist-party').value = d.party;
  $('dist-cook').value = d.cook_2026;
  $('dist-pvi').value = d.cook_pvi || '';
  $('dist-density').value = d.density_score;
  $('dist-persuasion').value = d.persuasion_score;
  $('dist-notes').value = d.notes || '';
  $('dist-fields').classList.remove('hidden');
}

async function saveDistrict() {
  const id = $('dist-select').value;
  const { error } = await sb.from('districts').update({
    rep: $('dist-rep').value,
    party: $('dist-party').value,
    cook_2026: $('dist-cook').value,
    cook_pvi: $('dist-pvi').value,
    density_score: parseInt($('dist-density').value),
    persuasion_score: parseInt($('dist-persuasion').value),
    notes: $('dist-notes').value,
  }).eq('id', id);
  showStatus('dist-status', error ? `Error: ${error.message}` : `âœ“ ${id} updated successfully`, !error);
  if (!error) loadAdminData();
}

async function saveIncident() {
  const { error } = await sb.from('temple_incidents').insert({
    date: $('inc-date').value,
    location: $('inc-location').value,
    target: $('inc-target').value,
    type: $('inc-type').value,
    bias: $('inc-bias').value,
    severity: $('inc-severity').value,
    description: $('inc-desc').value,
    source: $('inc-source').value,
  });
  showStatus('inc-status', error ? `Error: ${error.message}` : 'âœ“ Incident added', !error);
  if (!error) ['inc-date','inc-location','inc-target','inc-desc','inc-source'].forEach(id => $(id).value = '');
}

async function saveEvent() {
  const { error } = await sb.from('discourse_events').insert({
    date: $('evt-date').value,
    type: $('evt-type').value,
    valence: $('evt-valence').value,
    actor: $('evt-actor').value,
    event: $('evt-event').value,
    detail: $('evt-detail').value,
    source: $('evt-source').value,
  });
  showStatus('evt-status', error ? `Error: ${error.message}` : 'âœ“ Event added', !error);
  if (!error) ['evt-date','evt-actor','evt-event','evt-detail','evt-source'].forEach(id => $(id).value = '');
}

function loadNarrativeData() {
  const id = parseInt($('narr-select').value);
  if (!id) { $('narr-fields').classList.add('hidden'); return; }
  const n = allNarratives.find(x => x.id === id);
  if (!n) return;
  $('narr-intensity').value = n.intensity;
  $('narr-direction').value = n.direction;
  $('narr-desc').value = n.description;
  $('narr-framing').value = n.sample_framing;
  $('narr-daterange').value = n.date_range;
  $('narr-fields').classList.remove('hidden');
}

async function saveNarrative() {
  const id = parseInt($('narr-select').value);
  const { error } = await sb.from('narrative_items').update({
    intensity: $('narr-intensity').value,
    direction: $('narr-direction').value,
    description: $('narr-desc').value,
    sample_framing: $('narr-framing').value,
    date_range: $('narr-daterange').value,
    last_updated: `Updated ${new Date().toLocaleString('en-US', { month: 'short', year: 'numeric' })}`,
  }).eq('id', id);
  showStatus('narr-status', error ? `Error: ${error.message}` : 'âœ“ Narrative updated', !error);
}

function loadSenateData() {
  const st = $('sen-select').value;
  if (!st) { $('sen-fields').classList.add('hidden'); return; }
  const s = allSenate.find(x => x.state === st);
  if (!s) return;
  $('sen-incumbent').value = s.incumbent;
  $('sen-rating').value = s.rating;
  $('sen-notes').value = s.notes || '';
  $('sen-fields').classList.remove('hidden');
}

async function saveSenate() {
  const st = $('sen-select').value;
  const { error } = await sb.from('senate_races').update({
    incumbent: $('sen-incumbent').value,
    rating: $('sen-rating').value,
    notes: $('sen-notes').value,
  }).eq('state', st);
  showStatus('sen-status', error ? `Error: ${error.message}` : `âœ“ ${st} updated`, !error);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADER: OVERPASS (Temples)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function runOverpass() {
  const btn = $('btn-overpass');
  btn.disabled = true;
  showStatus('overpass-status', 'â³ Querying OpenStreetMap for Hindu temples and Sikh gurdwaras...', true);

  try {
    const query = `[out:json][timeout:90];
area["ISO3166-1"="US"]->.usa;
(
  nwr["amenity"="place_of_worship"]["religion"="hindu"](area.usa);
  nwr["amenity"="place_of_worship"]["religion"="sikh"](area.usa);
);
out center;`;

    const res = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      body: 'data=' + encodeURIComponent(query),
    });
    const data = await res.json();
    const elements = data.elements || [];

    const temples = elements.map(e => ({
      osm_id: e.id,
      name: e.tags?.name || 'Unnamed',
      religion: e.tags?.religion || 'unknown',
      lat: e.lat || e.center?.lat,
      lng: e.lon || e.center?.lon,
    })).filter(t => t.lat && t.lng);

    const hindu = temples.filter(t => t.religion === 'hindu').length;
    const sikh = temples.filter(t => t.religion === 'sikh').length;
    showStatus('overpass-status', `âœ“ Found ${temples.length} places of worship (${hindu} Hindu, ${sikh} Sikh). Mapping to districts...`, true);

    const DISTRICT_CENTERS = {
      "CA-17": [37.36, -121.97], "NJ-07": [40.63, -74.55], "IL-08": [42.03, -88.08],
      "CA-06": [38.58, -121.49], "TX-22": [29.62, -95.64], "NJ-11": [40.86, -74.40],
      "VA-10": [39.04, -77.49], "WA-07": [47.61, -122.33], "TX-10": [30.27, -96.40],
      "MI-13": [42.33, -83.05], "NJ-06": [40.52, -74.35], "GA-07": [33.96, -84.07],
      "NY-03": [40.76, -73.58], "PA-06": [40.03, -75.61], "NC-09": [35.23, -80.84],
      "TX-24": [32.81, -96.95], "CA-16": [37.34, -121.89], "NJ-12": [40.35, -74.66],
      "VA-11": [38.83, -77.28], "NY-04": [40.72, -73.56], "CA-14": [37.70, -121.93],
      "NJ-05": [41.00, -74.15], "MD-08": [39.08, -77.15], "CA-32": [34.19, -118.53],
    };

    const MAX_RADIUS_KM = 35;

    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    const results = temples.map(t => {
      let bestDist = Infinity, bestId = null;
      for (const [id, [cLat, cLng]] of Object.entries(DISTRICT_CENTERS)) {
        const d = haversineKm(t.lat, t.lng, cLat, cLng);
        if (d < bestDist) { bestDist = d; bestId = id; }
      }
      return {
        ...t,
        district_id: bestDist <= MAX_RADIUS_KM ? bestId : null,
        distance_km: Math.round(bestDist),
      };
    });

    const counts = {};
    TRACKED_DISTRICTS.forEach(d => counts[d] = { hindu: 0, sikh: 0, total: 0, names: [] });
    const inDistrict = results.filter(r => r.district_id);
    inDistrict.forEach(r => {
      if (r.religion === 'hindu') counts[r.district_id].hindu++;
      else if (r.religion === 'sikh') counts[r.district_id].sikh++;
      counts[r.district_id].total++;
      if (r.name !== 'Unnamed') counts[r.district_id].names.push(r.name);
    });

    overpassResults = { raw: results, counts };

    const trackedWithData = Object.entries(counts).filter(([, c]) => c.total > 0).sort((a, b) => b[1].total - a[1].total);
    const outside = results.filter(r => !r.district_id).length;

    let html = `<p class="text-sm mb-8"><strong>${temples.length}</strong> temples found nationwide. <strong>${inDistrict.length}</strong> are within ${MAX_RADIUS_KM}km of your 24 tracked district centers. <strong>${trackedWithData.length}</strong> districts have at least one temple. ${outside} are in other areas.</p>`;
    html += '<table class="preview-table"><tr><th>District</th><th>Hindu</th><th>Sikh</th><th>Total</th><th>Examples</th></tr>';
    trackedWithData.forEach(([id, c]) => {
      const examples = c.names.slice(0, 2).join(', ') + (c.names.length > 2 ? ` +${c.names.length - 2} more` : '');
      html += `<tr><td class="mono font-bold">${id}</td><td>${c.hindu}</td><td>${c.sikh}</td><td><strong>${c.total}</strong></td><td class="text-muted" style="font-size:11px; max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${examples}</td></tr>`;
    });
    html += '</table>';
    html += `<p class="text-muted mt-8">Method: Haversine distance from temple coordinates to district center. Radius: ${MAX_RADIUS_KM}km. Some edge-case misassignments possible near district borders.</p>`;
    $('overpass-preview').innerHTML = html;
    $('btn-overpass-save').classList.remove('hidden');
    showStatus('overpass-status', `âœ“ Mapping complete! ${inDistrict.length} temples in tracked districts. Review and save.`, true);

  } catch (err) {
    showStatus('overpass-status', `Error: ${err.message}`, false);
  }
  btn.disabled = false;
  $('overpass-progress').classList.add('hidden');
}

async function saveOverpassData() {
  if (!overpassResults) return;
  const btn = $('btn-overpass-save');
  btn.disabled = true;
  showStatus('overpass-status', 'â³ Saving to database...', true);

  try {
    await sb.from('osm_temples').delete().neq('id', 0);
    await sb.from('district_temple_counts').delete().neq('district_id', '');

    const rows = overpassResults.raw.filter(r => r.district_id).map(r => ({
      osm_id: r.osm_id, name: r.name, religion: r.religion,
      lat: r.lat, lng: r.lng, district_id: r.district_id,
    }));
    for (let i = 0; i < rows.length; i += 50) {
      const { error } = await sb.from('osm_temples').insert(rows.slice(i, i + 50));
      if (error) throw error;
    }

    const countRows = Object.entries(overpassResults.counts).map(([id, c]) => ({
      district_id: id, hindu_temples: c.hindu, sikh_gurdwaras: c.sikh, total: c.total,
    }));
    const { error } = await sb.from('district_temple_counts').insert(countRows);
    if (error) throw error;

    showStatus('overpass-status', `âœ“ Saved ${rows.length} temples and ${countRows.length} district counts to database.`, true);
    btn.classList.add('hidden');
  } catch (err) {
    showStatus('overpass-status', `Error saving: ${err.message}`, false);
  }
  btn.disabled = false;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADER: CENSUS LANGUAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function runCensus() {
  const btn = $('btn-census');
  btn.disabled = true;
  showStatus('census-status', 'â³ Querying Census ACS for language data...', true);

  try {
    const vintages = ['2022', '2021', '2023'];
    let data = null;
    let usedVintage = null;

    for (const yr of vintages) {
      showStatus('census-status', `â³ Trying ACS ${yr}...`, true);
      try {
        const vars = 'NAME,C16001_001E,C16001_015E,C16001_017E,C16001_030E,C16001_032E';
        const url = `https://api.census.gov/data/${yr}/acs/acs5?get=${vars}&for=congressional%20district:*&in=state:*&key=${CENSUS_KEY}`;
        const res = await fetch(url);
        if (res.ok) {
          data = await res.json();
          usedVintage = yr;
          break;
        }
      } catch (e) { /* try next vintage */ }
    }

    if (!data) {
      showStatus('census-status', 'â³ Detailed language table unavailable at CD level. Trying simplified approach...', true);
      const url = `https://api.census.gov/data/2022/acs/acs5?get=NAME,B16004_001E,B16004_067E,B16004_068E,B16004_069E&for=congressional%20district:*&in=state:*&key=${CENSUS_KEY}`;
      const res = await fetch(url);
      if (res.ok) {
        data = await res.json();
        usedVintage = '2022-B16004';
      }
    }

    if (!data) {
      const url = `https://api.census.gov/data/2022/acs/acs5/profile?get=NAME,DP02_0113E,DP02_0114E&for=congressional%20district:*&in=state:*&key=${CENSUS_KEY}`;
      const res = await fetch(url);
      if (res.ok) {
        data = await res.json();
        usedVintage = '2022-DP02';
      } else {
        const errText = await res.text();
        throw new Error(`All Census language tables returned errors. Last attempt: ${res.status} â€” ${errText.substring(0, 300)}`);
      }
    }

    const headers = data[0];
    const rows = data.slice(1);
    censusResults = [];

    rows.forEach(row => {
      const stFips = row[headers.indexOf('state')];
      const cdNum = row[headers.indexOf('congressional district')];
      const stAbbr = FIPS[stFips];
      if (!stAbbr) return;
      const distId = `${stAbbr}-${String(parseInt(cdNum)).padStart(2, '0')}`;
      if (!TRACKED_DISTRICTS.has(distId)) return;

      let totalPop5plus = 0, totalSpeakers = 0, totalLEP = 0;

      if (usedVintage && !usedVintage.includes('-')) {
        totalPop5plus = parseInt(row[headers.indexOf('C16001_001E')]) || 0;
        const indoEuroTotal = parseInt(row[headers.indexOf('C16001_015E')]) || 0;
        const indoEuroLEP = parseInt(row[headers.indexOf('C16001_017E')]) || 0;
        const otherAsianTotal = parseInt(row[headers.indexOf('C16001_030E')]) || 0;
        const otherAsianLEP = parseInt(row[headers.indexOf('C16001_032E')]) || 0;
        totalSpeakers = indoEuroTotal + otherAsianTotal;
        totalLEP = indoEuroLEP + otherAsianLEP;
      } else if (usedVintage === '2022-B16004') {
        totalPop5plus = parseInt(row[headers.indexOf('B16004_001E')]) || 0;
        totalSpeakers = parseInt(row[headers.indexOf('B16004_067E')]) || 0;
        totalLEP = parseInt(row[headers.indexOf('B16004_068E')]) || 0;
      } else {
        totalPop5plus = parseInt(row[headers.indexOf('DP02_0113E')]) || 0;
        totalSpeakers = parseInt(row[headers.indexOf('DP02_0114E')]) || 0;
        totalLEP = 0;
      }

      censusResults.push({
        district_id: distId,
        total_pop_5plus: totalPop5plus,
        south_asian_lang_speakers: totalSpeakers,
        south_asian_lep: totalLEP,
        lep_pct: totalPop5plus > 0 ? parseFloat((totalLEP / totalPop5plus * 100).toFixed(2)) : 0,
        data_vintage: `ACS 5-Year (${usedVintage})`,
      });
    });

    censusResults.sort((a, b) => b.south_asian_lang_speakers - a.south_asian_lang_speakers);

    let caveat = '';
    if (usedVintage && !usedVintage.includes('-')) {
      caveat = '"Other Indo-European" (Hindi, Gujarati, Urdu, Punjabi) + "Other Asian" (Telugu, Tamil, Kannada). Both categories include some nonâ€“South Asian languages â€” treat as upper-bound.';
    } else {
      caveat = 'Used fallback table â€” less granular than preferred. Language categories are broader.';
    }

    let html = `<p class="text-sm mb-8">Language data for <strong>${censusResults.length}</strong> tracked districts. Source: ACS ${usedVintage}.</p>`;
    html += `<p class="text-muted mb-8">${caveat}</p>`;
    html += '<table class="preview-table"><tr><th>District</th><th>S. Asian Lang. Speakers</th><th>LEP Count</th><th>LEP %</th></tr>';
    censusResults.forEach(r => {
      html += `<tr><td class="mono font-bold">${r.district_id}</td><td>${r.south_asian_lang_speakers.toLocaleString()}</td><td>${r.south_asian_lep.toLocaleString()}</td><td>${r.lep_pct}%</td></tr>`;
    });
    html += '</table>';
    $('census-preview').innerHTML = html;
    $('btn-census-save').classList.remove('hidden');
    showStatus('census-status', `âœ“ Data pulled for ${censusResults.length} districts (${usedVintage}). Review and save.`, true);

  } catch (err) {
    showStatus('census-status', `Error: ${err.message}`, false);
  }
  btn.disabled = false;
}

async function saveCensusData() {
  if (!censusResults?.length) return;
  const btn = $('btn-census-save');
  btn.disabled = true;

  try {
    await sb.from('census_language').delete().neq('district_id', '');
    await sb.from('census_language').insert(censusResults);
    showStatus('census-status', `âœ“ Saved language data for ${censusResults.length} districts.`, true);
    btn.classList.add('hidden');
  } catch (err) {
    showStatus('census-status', `Error: ${err.message}`, false);
  }
  btn.disabled = false;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADER: VERIFY POPULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function runVerify() {
  const btn = $('btn-verify');
  btn.disabled = true;
  showStatus('verify-status', 'â³ Pulling Asian Indian population from Census...', true);

  try {
    const url = `https://api.census.gov/data/2022/acs/acs5?get=NAME,B02015_002E&for=congressional%20district:*&in=state:*&key=${CENSUS_KEY}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Census API returned ${res.status}`);
    const data = await res.json();
    const headers = data[0];
    const rows = data.slice(1);

    const censusMap = {};
    rows.forEach(row => {
      const stFips = row[headers.indexOf('state')];
      const cdNum = row[headers.indexOf('congressional district')];
      const stAbbr = FIPS[stFips];
      if (!stAbbr) return;
      const distId = `${stAbbr}-${String(parseInt(cdNum)).padStart(2, '0')}`;
      const pop = parseInt(row[headers.indexOf('B02015_002E')]) || 0;
      censusMap[distId] = pop;
    });

    let html = '<table class="preview-table"><tr><th>District</th><th>Your Data</th><th>Census ACS</th><th>Diff</th><th>Status</th></tr>';
    allDistricts.forEach(d => {
      const censusPop = censusMap[d.id];
      const yourPop = d.indian_pop;
      if (censusPop === undefined) { html += `<tr><td class="mono font-bold">${d.id}</td><td>${yourPop?.toLocaleString()}</td><td>â€”</td><td>â€”</td><td class="badge badge-saffron">Not found</td></tr>`; return; }
      const diff = yourPop - censusPop;
      const pctDiff = censusPop > 0 ? Math.abs(diff / censusPop * 100).toFixed(0) : 0;
      const ok = pctDiff < 15;
      html += `<tr><td class="mono font-bold">${d.id}</td><td>${yourPop?.toLocaleString()}</td><td>${censusPop.toLocaleString()}</td><td>${diff > 0 ? '+' : ''}${diff.toLocaleString()}</td><td><span class="badge ${ok ? 'badge-green' : 'badge-saffron'}">${ok ? 'âœ“ OK' : pctDiff + '% off'}</span></td></tr>`;
    });
    html += '</table>';
    html += '<p class="text-muted mt-8">Note: Census ACS 2022 uses 118th Congress districts. Your data may use adjusted estimates for the 119th. Differences under 15% are expected.</p>';
    $('verify-preview').innerHTML = html;
    showStatus('verify-status', 'âœ“ Comparison complete.', true);

  } catch (err) {
    showStatus('verify-status', `Error: ${err.message}`, false);
  }
  btn.disabled = false;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONGRESS.GOV BILL TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let billSearchResults = [];

async function searchBills() {
  const query = $('bill-query').value.trim();
  if (!query) { showStatus('bill-status', 'Enter a search term.', false); return; }

  showStatus('bill-status', `â³ Searching Congress.gov for "${query}"...`, true);

  try {
    const url = `https://api.congress.gov/v3/bill?query=${encodeURIComponent(query)}&limit=20&sort=updateDate+desc&api_key=${CONGRESS_KEY}`;
    const res = await fetch(url);
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Congress API returned ${res.status}: ${text.substring(0, 200)}`);
    }
    const data = await res.json();
    const bills = data.bills || [];

    if (!bills.length) {
      showStatus('bill-status', `No bills found for "${query}". Try broader terms like "immigration" or "India".`, true);
      $('bill-preview').innerHTML = '';
      return;
    }

    billSearchResults = bills;

    let html = `<p class="text-sm mb-8">${bills.length} results for "${query}". Click Track to add a bill to your dashboard.</p>`;
    html += '<div style="display:grid; gap:10px;">';

    bills.forEach((bill, i) => {
      const congress = bill.congress || '';
      const type = bill.type || '';
      const number = bill.number || '';
      const title = bill.title || 'No title';
      const latestAction = bill.latestAction?.text || 'No action recorded';
      const latestDate = bill.latestAction?.actionDate || '';
      const policyArea = bill.policyArea?.name || '';

      html += `<div class="card" style="border-color:#E8E3D8;">
        <div class="card-body" style="padding:12px 16px;">
          <div class="flex justify-between items-center" style="flex-wrap:wrap; gap:8px;">
            <div style="flex:1; min-width:200px;">
              <div class="flex gap-8 items-center mb-4">
                <span class="mono font-bold" style="font-size:13px; color:#1E3A5F;">${type}${number}</span>
                <span class="badge" style="background:#F1F5F9; color:#4A5568;">${congress}th Congress</span>
                ${policyArea ? `<span class="badge badge-saffron">${policyArea}</span>` : ''}
              </div>
              <div style="font-size:13px; line-height:1.5; margin-bottom:6px;">${title.length > 150 ? title.substring(0, 150) + '...' : title}</div>
              <div class="text-muted" style="font-size:11px;">
                ${latestDate}: ${latestAction.length > 100 ? latestAction.substring(0, 100) + '...' : latestAction}
              </div>
            </div>
            <div class="flex gap-8">
              <button class="btn btn-sm btn-saffron" onclick="trackBill(${i})">Track</button>
            </div>
          </div>
        </div>
      </div>`;
    });
    html += '</div>';

    $('bill-preview').innerHTML = html;
    showStatus('bill-status', `âœ“ Found ${bills.length} bills.`, true);

  } catch (err) {
    showStatus('bill-status', `Error: ${err.message}`, false);
  }
}

async function trackBill(index) {
  const bill = billSearchResults[index];
  if (!bill) return;

  const congress = bill.congress || 119;
  const type = (bill.type || '').toLowerCase();
  const number = bill.number || 0;
  const billId = `${type}${number}-${congress}`;

  const titleLower = (bill.title || '').toLowerCase();
  let relevanceTag = 'other';
  if (titleLower.includes('h-1b') || titleLower.includes('h1b')) relevanceTag = 'h1b';
  else if (titleLower.includes('green card') || titleLower.includes('immigrant visa') || titleLower.includes('employment-based')) relevanceTag = 'green_card';
  else if (titleLower.includes('hate') || titleLower.includes('discrimination') || titleLower.includes('bias')) relevanceTag = 'hate_crimes';
  else if (titleLower.includes('india') || titleLower.includes('indo-pacific')) relevanceTag = 'india_relations';
  else if (titleLower.includes('immigration') || titleLower.includes('visa')) relevanceTag = 'immigration';
  else if (titleLower.includes('sikh') || titleLower.includes('hindu')) relevanceTag = 'civil_rights';

  const action = (bill.latestAction?.text || '').toLowerCase();
  let status = 'introduced';
  if (action.includes('became public law') || action.includes('signed by president')) status = 'enacted';
  else if (action.includes('passed senate') && action.includes('passed house')) status = 'passed_both';
  else if (action.includes('passed senate')) status = 'passed_senate';
  else if (action.includes('passed house')) status = 'passed_house';
  else if (action.includes('committee')) status = 'committee';

  const row = {
    bill_id: billId,
    congress,
    bill_type: type,
    bill_number: number,
    title: bill.title || '',
    latest_action: bill.latestAction?.text || '',
    latest_action_date: bill.latestAction?.actionDate || '',
    status,
    policy_area: bill.policyArea?.name || '',
    relevance_tag: relevanceTag,
    url: `https://www.congress.gov/bill/${congress}th-congress/${type === 'hr' ? 'house-bill' : type === 's' ? 'senate-bill' : type + '-bill'}/${number}`,
  };

  const { error } = await sb.from('tracked_bills').upsert(row, { onConflict: 'bill_id' });
  if (error) {
    alert(`Error tracking bill: ${error.message}`);
  } else {
    event.target.textContent = 'âœ“ Tracked';
    event.target.disabled = true;
    event.target.classList.remove('btn-saffron');
    event.target.classList.add('btn-outline');
    const { count } = await sb.from('tracked_bills').select('*', { count: 'exact', head: true });
    $('tracked-count').textContent = count || 0;
  }
}

async function loadTrackedBills() {
  const { data, error } = await sb.from('tracked_bills').select('*').order('latest_action_date', { ascending: false });
  if (error) { $('tracked-bills-list').innerHTML = `<div class="status status-error">Error: ${error.message}</div>`; return; }
  if (!data?.length) { $('tracked-bills-list').innerHTML = '<p class="text-muted">No tracked bills yet. Search and click Track to add bills.</p>'; return; }

  $('tracked-count').textContent = data.length;

  const tagColors = {
    h1b: { bg: '#DBEAFE', color: '#1E40AF' },
    green_card: { bg: '#ECFDF5', color: '#047857' },
    hate_crimes: { bg: '#FEF2F2', color: '#991B1B' },
    india_relations: { bg: '#FFFBEB', color: '#92400E' },
    immigration: { bg: '#EDE9FE', color: '#6D28D9' },
    civil_rights: { bg: '#FEF3C7', color: '#92400E' },
    other: { bg: '#F5F2EB', color: '#4A5568' },
  };

  let html = '<div style="display:grid; gap:10px;">';
  data.forEach(b => {
    const tc = tagColors[b.relevance_tag] || tagColors.other;
    const statusLabel = (b.status || 'introduced').replace('_', ' ');
    html += `<div class="card" style="border-color:#E8E3D8;">
      <div class="card-body" style="padding:12px 16px;">
        <div class="flex justify-between items-center" style="flex-wrap:wrap; gap:8px;">
          <div style="flex:1; min-width:200px;">
            <div class="flex gap-8 items-center mb-4">
              <span class="mono font-bold" style="font-size:13px; color:#1E3A5F;">${b.bill_type?.toUpperCase()}${b.bill_number}</span>
              <span class="badge" style="background:${tc.bg}; color:${tc.color};">${b.relevance_tag?.replace('_',' ')}</span>
              <span class="badge" style="background:#F1F5F9; color:#4A5568;">${statusLabel}</span>
            </div>
            <div style="font-size:13px; line-height:1.5; margin-bottom:6px;">${b.title?.length > 150 ? b.title.substring(0, 150) + '...' : b.title}</div>
            <div class="text-muted" style="font-size:11px;">
              ${b.latest_action_date || ''}: ${b.latest_action || 'No action'}
            </div>
          </div>
          <div class="flex gap-8">
            <a href="${b.url}" target="_blank" class="btn btn-sm btn-outline">View â†—</a>
            <button class="btn btn-sm btn-danger" onclick="untrackBill('${b.bill_id}')">Remove</button>
          </div>
        </div>
      </div>
    </div>`;
  });
  html += '</div>';
  $('tracked-bills-list').innerHTML = html;
}

async function untrackBill(billId) {
  if (!confirm('Remove this bill from tracking?')) return;
  await sb.from('tracked_bills').delete().eq('bill_id', billId);
  loadTrackedBills();
}

async function loadTrackedCount() {
  const { count } = await sb.from('tracked_bills').select('*', { count: 'exact', head: true });
  $('tracked-count').textContent = count || 0;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadTableSummary() {
  const tables = ['districts','senate_races','fbi_trend_data','temple_incidents','discourse_events','narrative_items','pres_vote_trend','gender_age_vote','party_id','top_issues','precinct_swings','osm_temples','district_temple_counts','census_language','h1b_perm_by_district','h1b_state_summary','tracked_bills','economic_contribution'];
  let html = '<table class="preview-table"><tr><th>Table</th><th>Rows</th></tr>';
  for (const t of tables) {
    const { count } = await sb.from(t).select('*', { count: 'exact', head: true });
    html += `<tr><td class="mono">${t}</td><td>${count ?? 'â€”'}</td></tr>`;
  }
  html += '</table>';
  $('table-summary').innerHTML = html;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function $(id) { return document.getElementById(id); }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function showStatus(elId, msg, success) {
  const el = $(elId);
  el.innerHTML = `<div class="status ${success ? 'status-success' : 'status-error'}">${msg}</div>`;
}

function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  $(`tab-${tab}`).classList.add('active');
  event.target.classList.add('active');
}

function switchSubTab(id) {
  document.querySelectorAll('.sub-content').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.sub-tab').forEach(el => el.classList.remove('active'));
  $(id).classList.remove('hidden');
  event.target.classList.add('active');
}

function switchBillView(view) {
  $('bill-search-view').classList.toggle('hidden', view !== 'search');
  $('bill-tracked-view').classList.toggle('hidden', view !== 'tracked');
  document.querySelectorAll('#tab-loaders .card:last-of-type .sub-tab').forEach(el => el.classList.remove('active'));
  event.target.classList.add('active');
  if (view === 'tracked') loadTrackedBills();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISCOURSE LOADER â€” GDELT + GOVINFO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DISC_QUERY_PACKS = {
  h1b:           { gdelt: '"H-1B" OR "H1B" OR "tech worker visa"',               tv: '"H-1B" OR "H1B visa"',                     gov: 'H-1B visa technology workers' },
  iamerican:     { gdelt: '"Indian Americans" OR "Indian American community"',    tv: '"Indian Americans" OR "Indian American voters"', gov: 'Indian Americans community' },
  southasian:    { gdelt: '"South Asian" hate crime OR discrimination',           tv: '"South Asian" hate OR discrimination',      gov: 'South Asian hate crimes discrimination' },
  indiarelations:{ gdelt: '"United States" India relations OR "US-India"',        tv: '"US-India" OR "United States India"',       gov: 'United States India bilateral relations' },
  greencard:     { gdelt: '"green card" backlog OR "employment-based" visa India', tv: '"green card" backlog India',               gov: 'green card employment based immigration backlog India' },
};

let discData = { articles: [], clips: [], speeches: [] };
let discNarrativeKey = 'h1b';

function discOnPackChange() {
  const v = $('disc-queryPack').value;
  $('disc-customRow').style.display = v === 'custom' ? 'block' : 'none';
}

function discSetStatus(msg, ok) {
  showStatus('disc-status', msg, ok !== false && ok !== undefined ? ok : false);
  if (ok === 'loading') {
    $('disc-status').innerHTML = `<div class="status status-success" style="background:#EFF6FF; color:#1D4ED8; border-color:#BFDBFE;">${msg}</div>`;
  }
}

function discExtractDomain(url) {
  try { return new URL(url).hostname.replace('www.',''); } catch { return 'unknown'; }
}
function discParseDate(d) {
  if (!d || d.length < 8) return null;
  return `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}T${d.slice(8,10)||'00'}:${d.slice(10,12)||'00'}:00Z`;
}
function discAvgTone(arts) {
  if (!arts.length) return 0;
  return arts.reduce((s,a)=>s+a.tone_score,0)/arts.length;
}
function discDomainCounts(arts) {
  const c={};
  arts.forEach(a=>{c[a.domain]=(c[a.domain]||0)+1;});
  return Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,7).map(([d,n])=>({domain:d,count:n}));
}
function discStationCounts(clips) {
  const c={};
  clips.forEach(cl=>{c[cl.station]=(c[cl.station]||0)+1;});
  return Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,7).map(([s,n])=>({station:s,count:n}));
}
function discFmtDate(iso) {
  if (!iso) return '';
  try { return new Date(iso).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); } catch { return iso; }
}
function discEsc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// GDELT uses JSONP to bypass CORS â€” injects a <script> tag, no fetch needed
function discGdeltJsonp(url) {
  return new Promise((resolve, reject) => {
    const cbName = 'gdelt_cb_' + Date.now();
    const script = document.createElement('script');
    const timer = setTimeout(() => {
      delete window[cbName];
      script.remove();
      reject(new Error('GDELT request timed out after 15s'));
    }, 15000);
    window[cbName] = (data) => {
      clearTimeout(timer);
      delete window[cbName];
      script.remove();
      resolve(data);
    };
    script.src = url + '&callback=' + cbName;
    script.onerror = () => {
      clearTimeout(timer);
      delete window[cbName];
      script.remove();
      reject(new Error('GDELT script load failed â€” check network'));
    };
    document.head.appendChild(script);
  });
}

async function discFetchGdeltDoc(query, timespan, maxRecords) {
  // format=json is ignored when callback= is present; GDELT returns JSONP
  const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=${encodeURIComponent(query)}&mode=artlist&maxrecords=${maxRecords}&timespan=${timespan}&sort=hybridrel&format=json`;
  const data = await discGdeltJsonp(url);
  return (data.articles||[]).map(a=>({
    title: a.title||'(no title)', url: a.url||'',
    domain: a.domain||discExtractDomain(a.url),
    published_at: a.seendate ? discParseDate(a.seendate) : null,
    tone_score: parseFloat(a.tone)||0,
  }));
}

async function discFetchGdeltTv(query, timespan) {
  const url = `https://api.gdeltproject.org/api/v2/tv/tv?query=${encodeURIComponent(query)}&mode=clipgallery&maxclips=20&timespan=${timespan}&datacomb=or&format=json`;
  const data = await discGdeltJsonp(url);
  const clips = data.clips || data.show_clips || [];
  return clips.map(c=>({
    station: c.station||c.network||'Unknown', show: c.show||c.program||'',
    date: c.date||c.datetime||'', snippet: c.snippet||c.preview||'', url: c.previewUrl||c.url||'',
  }));
}

async function discFetchGovInfo(query, apiKey) {
  // GovInfo blocks browser CORS â€” routed through /api/govinfo Vercel serverless function
  if (!apiKey) return [];
  const res = await fetch(`/api/govinfo?query=${encodeURIComponent(query)}&api_key=${encodeURIComponent(apiKey)}`);
  if (!res.ok) {
    const err = await res.text().catch(()=>'');
    throw new Error(`GovInfo proxy HTTP ${res.status}: ${err.slice(0,120)}`);
  }
  const data = await res.json();
  return (data.results||[]).map(r=>({
    title: r.title||r.packageId||'(no title)',
    url: r.detailsLink||'',
    published_at: r.dateIssued||null,
    snippet: r.context||r.title||'',
    chamber: r.granuleClass||'',
  }));
}

function discRenderGdelt(arts) {
  $('disc-gdeltCount').textContent = arts.length||'0';
  if (!arts.length) { $('disc-domains').innerHTML='<span style="color:#9CA3AF;">No results</span>'; $('disc-articles').innerHTML=''; return; }
  const avg = discAvgTone(arts);
  const pos = arts.filter(a=>a.tone_score>1).length;
  const neg = arts.filter(a=>a.tone_score<-1).length;
  $('disc-avgTone').textContent = avg.toFixed(2);
  $('disc-avgTone').style.color = avg>0?'#059669':avg<0?'#DC2626':'#1E3A5F';
  $('disc-posCount').textContent = pos;
  $('disc-negCount').textContent = neg;

  const domains = discDomainCounts(arts);
  const maxD = domains[0]?.count||1;
  $('disc-domains').innerHTML = domains.map((d,i)=>`
    <div style="display:flex; align-items:center; gap:8px; padding:5px 0; border-bottom:1px solid #F3F4F6; font-size:11px;">
      <span style="color:#9CA3AF; font-family:monospace; width:14px;">${i+1}</span>
      <span style="flex:1; color:#374151;">${discEsc(d.domain)}</span>
      <div style="width:60px; height:5px; background:#E5E7EB; border-radius:3px; overflow:hidden;">
        <div style="width:${Math.round(d.count/maxD*100)}%; height:100%; background:#D97706; border-radius:3px;"></div>
      </div>
      <span style="font-family:monospace; color:#6B7280; width:20px; text-align:right;">${d.count}</span>
    </div>`).join('');

  const sorted = [...arts].sort((a,b)=>(b.published_at||'')>(a.published_at||'')?1:-1).slice(0,12);
  $('disc-articles').innerHTML = sorted.map(a=>{
    const t = a.tone_score;
    const toneColor = t>1?'#059669':t<-1?'#DC2626':'#9CA3AF';
    const toneBg   = t>1?'#DCFCE7':t<-1?'#FEE2E2':'#F3F4F6';
    return `<div style="padding:9px 0; border-bottom:1px solid #F3F4F6;">
      <div style="font-size:12px; font-weight:600; color:#1E3A5F; margin-bottom:3px; line-height:1.4;">${discEsc(a.title)}</div>
      <div style="display:flex; gap:8px; font-size:10px; color:#9CA3AF; font-family:monospace; align-items:center;">
        <span>${discEsc(a.domain)}</span>
        <span>${discFmtDate(a.published_at)}</span>
        <span style="padding:1px 6px; border-radius:3px; background:${toneBg}; color:${toneColor};">${t>0?'+':''}${t.toFixed(1)}</span>
      </div>
    </div>`;
  }).join('');
}

function discRenderTV(clips) {
  $('disc-tvCount').textContent = clips.length||'0';
  if (!clips.length) { $('disc-stations').innerHTML='<span style="color:#9CA3AF;">No clips found</span>'; $('disc-clips').innerHTML=''; return; }
  const stations = discStationCounts(clips);
  const maxS = stations[0]?.count||1;
  $('disc-stations').innerHTML = stations.map((s,i)=>`
    <div style="display:flex; align-items:center; gap:8px; padding:5px 0; border-bottom:1px solid #F3F4F6; font-size:11px;">
      <span style="color:#9CA3AF; font-family:monospace; width:14px;">${i+1}</span>
      <span style="flex:1; color:#374151; font-weight:600;">${discEsc(s.station)}</span>
      <div style="width:60px; height:5px; background:#E5E7EB; border-radius:3px; overflow:hidden;">
        <div style="width:${Math.round(s.count/maxS*100)}%; height:100%; background:#059669; border-radius:3px;"></div>
      </div>
      <span style="font-family:monospace; color:#6B7280; width:20px; text-align:right;">${s.count}</span>
    </div>`).join('');
  $('disc-clips').innerHTML = clips.slice(0,8).map(c=>`
    <div style="padding:10px 0; border-bottom:1px solid #F3F4F6;">
      <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:#059669; margin-bottom:3px;">${discEsc(c.station)}${c.show?' Â· '+discEsc(c.show):''}</div>
      <div style="font-size:12px; color:#374151; line-height:1.5; margin-bottom:3px;">${discEsc(c.snippet||'(no preview)')}</div>
      <div style="font-size:10px; color:#9CA3AF; font-family:monospace;">${discFmtDate(c.date)}</div>
    </div>`).join('');
}

function discRenderGovInfo(speeches) {
  $('disc-govCount').textContent = speeches.length||'0';
  if (!speeches.length) {
    $('disc-speeches').innerHTML = `<span style="color:#9CA3AF;">${$('disc-govKey').value?'No floor speeches found':'Enter a GovInfo key above'}</span>`;
    return;
  }
  $('disc-speeches').innerHTML = speeches.map(s=>`
    <div style="padding:10px 0; border-bottom:1px solid #F3F4F6;">
      <div style="font-size:12px; font-weight:600; color:#1E3A5F; margin-bottom:4px;">${discEsc(s.title)}</div>
      ${s.snippet?`<div style="font-size:11px; color:#6B7280; border-left:2px solid #D97706; padding-left:8px; font-style:italic; margin-bottom:4px; line-height:1.5;">${discEsc(s.snippet.slice(0,260))}â€¦</div>`:''}
      <div style="font-size:10px; color:#9CA3AF; font-family:monospace;">${discFmtDate(s.published_at)}${s.chamber?' Â· '+discEsc(s.chamber):''}</div>
    </div>`).join('');
}

async function discRunAll() { await discFetch(true); }
async function discRunGdeltOnly() { await discFetch(false); }

async function discFetch(includeGov) {
  const packKey   = $('disc-queryPack').value;
  discNarrativeKey = packKey === 'custom' ? 'custom' : packKey;
  const pack      = DISC_QUERY_PACKS[packKey];
  const timespan  = $('disc-timespan').value;
  const maxRec    = $('disc-maxRecords').value;
  const govKey    = $('disc-govKey').value.trim();
  const gdeltQ    = packKey === 'custom' ? $('disc-customQuery').value : pack.gdelt;
  const tvQ       = packKey === 'custom' ? $('disc-customQuery').value : pack.tv;
  const govQ      = packKey === 'custom' ? $('disc-customQuery').value : pack?.gov;

  if (!gdeltQ) { discSetStatus('Please enter a search query.', false); return; }

  $('disc-runBtn').disabled = true;
  discData = { articles: [], clips: [], speeches: [] };
  $('disc-resultsGrid').style.display = 'grid';
  $('disc-writePanel').style.display = 'none';
  discSetStatus('Fetching GDELT Article archive (DOC 2.0)â€¦', 'loading');

  try {
    discData.articles = await discFetchGdeltDoc(gdeltQ, timespan, maxRec);
    discRenderGdelt(discData.articles);
    discSetStatus(`${discData.articles.length} articles. Fetching TV broadcastsâ€¦`, 'loading');
  } catch(e) {
    const msg = e.message || String(e);
    discSetStatus('GDELT DOC error: ' + msg, false);
    $('disc-gdeltCount').textContent = 'ERR';
    console.error('GDELT DOC full error:', e);
  }

  try {
    discData.clips = await discFetchGdeltTv(tvQ, timespan);
    discRenderTV(discData.clips);
    discSetStatus(`${discData.articles.length} articles Â· ${discData.clips.length} TV clips${includeGov&&govKey?' Â· fetching Congressional Recordâ€¦':'. Done.'}`, 'loading');
  } catch(e) {
    discSetStatus('GDELT TV error: ' + e.message, false);
  }

  if (includeGov && govKey) {
    try {
      discData.speeches = await discFetchGovInfo(govQ, govKey);
      discRenderGovInfo(discData.speeches);
    } catch(e) {
      discSetStatus('GovInfo error: ' + e.message, false);
    }
  } else {
    discRenderGovInfo([]);
  }

  const total = discData.articles.length + discData.clips.length + discData.speeches.length;
  discSetStatus(`âœ“ ${total} items loaded â€” ${discData.articles.length} articles Â· ${discData.clips.length} TV clips Â· ${discData.speeches.length} floor speeches.`, true);
  if (total > 0) discShowWritePanel();
  $('disc-runBtn').disabled = false;
}

function discShowWritePanel() {
  const avg = discAvgTone(discData.articles);
  const stats = [
    { val: discData.articles.length, label: 'Articles' },
    { val: discData.clips.length,    label: 'TV Clips' },
    { val: discData.speeches.length, label: 'Speeches' },
    { val: avg.toFixed(2),           label: 'Avg Tone', color: avg>0?'#059669':avg<0?'#DC2626':'#1E3A5F' },
  ];
  $('disc-writeSummary').innerHTML = stats.map(s=>`
    <div style="background:#F9FAFB; border:1px solid #E5E7EB; border-radius:8px; padding:12px; text-align:center;">
      <div style="font-family:monospace; font-size:22px; font-weight:700; color:${s.color||'#1E3A5F'};">${s.val}</div>
      <div style="font-size:10px; color:#9CA3AF; text-transform:uppercase; letter-spacing:.07em; margin-top:2px;">${s.label}</div>
    </div>`).join('');
  $('disc-writePanel').style.display = 'block';
  $('disc-writePanel').scrollIntoView({behavior:'smooth', block:'nearest'});
}

function discGetMonday(d) {
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  return new Date(new Date(d).setDate(diff));
}

async function discWriteToSupabase() {
  const btn = $('disc-writeBtn');
  btn.disabled = true;
  showStatus('disc-writeStatus', 'Writing discourse_itemsâ€¦', true);
  const now = new Date().toISOString();

  const allItems = [
    ...discData.articles.map(a=>({ source:'gdelt_doc', type:'article',    title:a.title, url:a.url, domain:a.domain, published_at:a.published_at, tone_score:a.tone_score, narrative_key:discNarrativeKey, station:null, snippet:null, fetched_at:now })),
    ...discData.clips.map(c=>({   source:'gdelt_tv',  type:'broadcast',   title:c.show||c.station, url:c.url, domain:null, published_at:c.date?new Date(c.date).toISOString():null, tone_score:null, narrative_key:discNarrativeKey, station:c.station, snippet:(c.snippet||'').slice(0,300), fetched_at:now })),
    ...discData.speeches.map(s=>({ source:'govinfo',  type:'floor_speech',title:s.title, url:s.url, domain:null, published_at:s.published_at, tone_score:null, narrative_key:discNarrativeKey, station:null, snippet:(s.snippet||'').slice(0,300), fetched_at:now })),
  ];

  const CHUNK = 100;
  let written = 0;
  for (let i=0; i<allItems.length; i+=CHUNK) {
    try {
      const { error } = await sb.from('discourse_items').upsert(allItems.slice(i,i+CHUNK), { onConflict: 'url', ignoreDuplicates: true });
      if (error) throw new Error(error.message);
      written += Math.min(CHUNK, allItems.length-i);
      showStatus('disc-writeStatus', `Writingâ€¦ ${written}/${allItems.length} rows`, true);
    } catch(e) {
      showStatus('disc-writeStatus', 'Write error: ' + e.message, false);
      btn.disabled = false; return;
    }
  }

  // Weekly rollup
  if (discData.articles.length > 0) {
    const weekStart = discGetMonday(new Date()).toISOString().slice(0,10);
    const rollup = {
      narrative_key: discNarrativeKey, week_start: weekStart,
      article_count: discData.articles.length,
      avg_tone: parseFloat(discAvgTone(discData.articles).toFixed(3)),
      pct_positive: parseFloat((discData.articles.filter(a=>a.tone_score>1).length/discData.articles.length*100).toFixed(2)),
      top_domains: discDomainCounts(discData.articles).slice(0,5),
      tv_station_counts: discStationCounts(discData.clips).slice(0,5),
      created_at: now,
    };
    await sb.from('narrative_media_signals').upsert(rollup, { onConflict: 'narrative_key,week_start' }).catch(()=>{});
  }

  showStatus('disc-writeStatus', `âœ“ ${written} items written to discourse_items. Weekly rollup saved to narrative_media_signals.`, true);
  btn.disabled = false;
}

function discClear() {
  discData = { articles:[], clips:[], speeches:[] };
  $('disc-resultsGrid').style.display = 'none';
  $('disc-writePanel').style.display = 'none';
  $('disc-status').innerHTML = '';
  ['disc-gdeltCount','disc-tvCount','disc-govCount'].forEach(id=>$(id).textContent='â€”');
  ['disc-avgTone','disc-posCount','disc-negCount'].forEach(id=>$(id).textContent='â€”');
  $('disc-domains').innerHTML = 'Run fetch to load';
  $('disc-articles').innerHTML = '';
  $('disc-stations').innerHTML = 'Run fetch to load';
  $('disc-clips').innerHTML = '';
  $('disc-speeches').innerHTML = 'GovInfo key required';
}

function discToggleSQL() {
  const b = $('disc-sqlBlock');
  const i = $('disc-sqlIcon');
  if (b.style.display==='none') { b.style.display='block'; i.textContent='â–² Hide'; }
  else { b.style.display='none'; i.textContent='â–¼ Show'; }
}




</script>
</body>
</html>
